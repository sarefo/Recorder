<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recorder Fingering Chart</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
            padding: 0 20px;
        }

        .fingering-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding-top: 20px;
        }

        #header-wrapper {
            position: sticky;
            top: 0;
            z-index: 101;
            background-color: #f4f4f4;
            padding-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        #reference-row {
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: 5px;
        }

        #reference-row .chart-container {
            width: auto;
            min-width: 35px;
            flex-grow: 0;
            flex-shrink: 1;
            padding: 5px;
        }

        #reference-row .note-input {
            width: 80%;
            font-size: 0.8em;
        }

        #reference-row .fingering-display {
            min-height: 110px;
        }

        #reference-row .hole {
            width: 15px;
            height: 15px;
        }

        #header-wrapper.minimized #reference-row {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        #header-wrapper.minimized #minimize-button {
            content: "+";
        }

        .chart-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: calc((100% - 152px) / 18);
            min-width: 45px;
            flex-grow: 0;
            flex-shrink: 1;
        }

        @media (max-width: 1200px) {
            .chart-container {
                width: calc((100% - 120px) / 14);
            }
        }

        @media (max-width: 900px) {
            .chart-container {
                width: calc((100% - 88px) / 10);
            }
        }

        @media (max-width: 600px) {
            .chart-container {
                width: calc((100% - 56px) / 6);
            }
        }

        .chart-container.bg-red {
            background-color: rgba(255, 0, 0, 0.1);
        }

        .chart-container.bg-green {
            background-color: rgba(0, 128, 0, 0.1);
        }

        .chart-container.black-key {
            border: 4px solid black;
        }

        .fingering-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .note-input {
            width: 90%;
            text-align: center;
            margin-bottom: 8px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .fingering-display {
            width: 100%;
            min-height: 130px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .fingering-holes {
            display: flex;
            flex-direction: column;
            gap: 0px;
            align-items: center;
            width: 100%;
        }

        .hand {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }

        .left-thumb {
            margin-bottom: 8px;
        }

        .hole.left-thumb.c {
            background-color: #888;
            /* Gray color for covered left thumb hole */
        }

        .hole.left-thumb.p {
            background: linear-gradient(45deg, #888 50%, white 50%);
            /* Gray gradient for partially covered left thumb hole */
        }

        .hole {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid #000;
            position: relative;
        }

        .o {
            background-color: white;
        }

        .c {
            background-color: black;
        }

        .p {
            background: linear-gradient(45deg, black 50%, white 50%);
        }

        .empty-fingering {
            color: #999;
            font-size: 11px;
        }

        .control-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
            background-color: #f4f4f4;
            position: sticky;
            top: 0;
            z-index: 101;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .control-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-grow: 1;
        }

        .minimize-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .minimize-label {
            font-size: 12px;
            color: #666;
        }

        #minimize-button {
            padding: 4px 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
        }

        .control-bar button {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
        }

        .control-bar button:hover {
            background-color: #f0f0f0;
        }

        .transpose-control {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
        }

        .transpose-buttons {
            display: flex;
            flex-direction: row;
            gap: 2px;
        }

        .transpose-buttons button {
            padding: 2px 5px;
            font-size: 10px;
        }

        .transpose-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chart-container.separator {
            border: none;
            box-shadow: none;
            width: 10px;
            min-width: 10px;
            padding: 0;
            margin: 0 5px;
            background-color: transparent;
        }

        .chart-container.rest {
            background-color: rgba(200, 200, 200, 0.2);
        }

        .duration-between-hands {
            font-size: 36px;
            margin: 0px 0;
            text-align: center;
        }

        .note-duration-centered {
            font-size: 32px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .notation-help {
            margin: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.4;
        }

        .fingering-display {
            position: relative;
        }
    </style>
</head>

<body>
    <div id="header-wrapper">
        <div class="control-bar" id="header-controls">

            <div class="control-buttons">
                <button id="paste-button" title="Paste notes from clipboard (Ctrl+V)">From clipboard (Ctrl+V)</button>
                <button id="copy-button" title="Copy notes to clipboard (Ctrl+C)">To clipboard (Ctrl+C)</button>
                <button id="fingering-toggle" title="Toggle between Baroque and German fingering">German</button>
                <div class="transpose-control">
                    <span>Transpose:</span>
                    <div class="transpose-buttons">
                        <button id="transpose-down" title="Transpose down a half step">&#9660;</button>
                        <button id="transpose-up" title="Transpose up a half step">&#9650;</button>
                    </div>
                </div>
            </div>

            <div class="minimize-controls">
                <span class="minimize-label">Chart</span>
                <button id="minimize-button" title="Minimize/Expand header">&#x2212;</button>
            </div>
        </div>
        <div class="fingering-grid" id="reference-row">
            <!-- Reference row will be filled with chart containers by JavaScript -->
        </div>
    </div>

    <div class="fingering-grid" id="note-grid">
        <!-- The rest of the grid will be filled with chart containers by JavaScript -->
    </div>

    <script>

        /*
        - Standard notes: C4, D#4, F5, etc.
        - Add duration with colon: C4:4 (quarter), F#5:8 (eighth), A4:16 (sixteenth)
        - Add dot for dotted notes: G4:4. (dotted quarter)
        - Use 0 for rests: 0:2 (half rest), 0:4 (quarter rest)
        - Use | for visual separators between phrases
        */
        const durationSymbols = {
            "1": "ùÖù", // Whole note
            "2": "ùÖû", // Half note
            "4": "ùÖü", // Quarter note
            "8": "ùÖ†", // Eighth note
            "16": "ùÖ°", // Sixteenth note
            "32": "ùÖ¢", // Thirty-second note
            "1.": "ùÖù.", // Dotted whole note
            "2.": "ùÖû.", // Dotted half note
            "4.": "ùÖü.", // Dotted quarter note
            "8.": "ùÖ†.", // Dotted eighth note
            "16.": "ùÖ°.", // Dotted sixteenth note
            "32.": "ùÖ¢." // Dotted thirty-second note
        };

        // Define the fingering patterns for each note
        // Baroque // 'F4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'o', 'c', 'c'] },
        const fingeringData = {
            // First octave
            'C4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'c', 'c', 'c'] },
            'C#4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'c', 'c', 'p'] },
            'D4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'c', 'c', 'o'] },
            'D#4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'c', 'p', 'o'] },
            'E4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'c', 'o', 'o'] },
            'F4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'o', 'c', 'c'] },
            'F#4': { left: ['c', 'c', 'c', 'c'], right: ['o', 'c', 'c', 'o'] },
            'G4': { left: ['c', 'c', 'c', 'c'], right: ['o', 'o', 'o', 'o'] },
            'G#4': { left: ['c', 'c', 'c', 'o'], right: ['c', 'c', 'o', 'o'] },
            'A4': { left: ['c', 'c', 'c', 'o'], right: ['o', 'o', 'o', 'o'] },
            'A#4': { left: ['c', 'c', 'o', 'c'], right: ['c', 'o', 'o', 'o'] },
            'B4': { left: ['c', 'c', 'o', 'o'], right: ['o', 'o', 'o', 'o'] },

            // Second octave
            'C5': { left: ['c', 'o', 'c', 'o'], right: ['o', 'o', 'o', 'o'] },
            'C#5': { left: ['o', 'c', 'c', 'o'], right: ['o', 'o', 'o', 'o'] },
            'D5': { left: ['o', 'o', 'c', 'o'], right: ['o', 'o', 'o', 'o'] },
            'D#5': { left: ['o', 'o', 'c', 'c'], right: ['c', 'c', 'c', 'o'] },
            'E5': { left: ['p', 'c', 'c', 'c'], right: ['c', 'c', 'o', 'o'] },
            'F5': { left: ['p', 'c', 'c', 'c'], right: ['c', 'o', 'c', 'o'] },
            'F#5': { left: ['p', 'c', 'c', 'c'], right: ['o', 'c', 'o', 'o'] },
            'G5': { left: ['p', 'c', 'c', 'c'], right: ['o', 'o', 'o', 'o'] },
            'G#5': { left: ['p', 'c', 'c', 'o'], right: ['c', 'o', 'o', 'o'] },
            'A5': { left: ['p', 'c', 'c', 'o'], right: ['o', 'o', 'o', 'o'] },
        };

        const fingeringDataGerman = {
            'F4': { left: ['c', 'c', 'c', 'c'], right: ['c', 'o', 'o', 'o'] },
            'F#4': { left: ['c', 'c', 'c', 'c'], right: ['o', 'c', 'c', 'c'] },
            'C#5': { left: ['c', 'o', 'o', 'o'], right: ['o', 'o', 'o', 'o'] },
            'F5': { left: ['p', 'c', 'c', 'c'], right: ['c', 'o', 'o', 'o'] },
            'F#5': { left: ['p', 'c', 'c', 'c'], right: ['o', 'c', 'o', 'c'] },
            'G#5': { left: ['p', 'c', 'c', 'c'], right: ['o', 'c', 'c', 'c'] },
        };

        const aliases = {
            'C': 'C4',
            'C#': 'C#4', 'DB': 'C#4', 'DB4': 'C#4',
            'D': 'D4',
            'D#': 'D#4', 'EB': 'D#4', 'EB4': 'D#4',
            'E': 'E4',
            'F': 'F4',
            'F#': 'F#4', 'GB': 'F#4', 'GB4': 'F#4',
            'G': 'G4',
            'G#': 'G#4', 'AB': 'G#4', 'AB4': 'G#4',
            'A': 'A4',
            'A#': 'A#4', 'BB': 'A#4', 'BB4': 'A#4',
            'B': 'B4'
        };

        const lowerOctaveAliases = {
            'C-': 'C3',
            'C#-': 'C#3', 'DB-': 'C#3', 'DB3': 'C#3',
            'D-': 'D3',
            'D#-': 'D#3', 'EB-': 'D#3', 'EB3': 'D#3',
            'E-': 'E3',
            'F-': 'F3',
            'F#-': 'F#3', 'GB-': 'F#3', 'GB3': 'F#3',
            'G-': 'G3',
            'G#-': 'G#3', 'AB-': 'G#3', 'AB3': 'G#3',
            'A-': 'A3',
            'A#-': 'A#3', 'BB-': 'A#3', 'BB3': 'A#3',
            'B-': 'B3'
        };

        const higherOctaveAliases = {
            'C+': 'C5',
            'C#+': 'C#5', 'DB+': 'C#5', 'DB5': 'C#5',
            'D+': 'D5',
            'D#+': 'D#5', 'EB+': 'D#5', 'EB5': 'D#5',
            'E+': 'E5',
            'F+': 'F5',
            'F#+': 'F#5', 'GB+': 'F#5', 'GB5': 'F#5',
            'G+': 'G5',
            'G#+': 'G#5', 'AB+': 'G#5', 'AB5': 'G#5',
            'A+': 'A5',
            'A#+': 'A#5', 'BB+': 'A#5', 'BB5': 'A#5',
            'B+': 'B5',
            'C++': 'C6'
        };

        const allNotes = [
            'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4',
            'C5', 'C#5', 'D5', 'D#5', 'E5', 'F5'
        ];

        const allNotesExtended = [
            'C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3',
            'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4',
            'C5', 'C#5', 'D5', 'D#5', 'E5', 'F5', 'F#5', 'G5', 'G#5', 'A5', 'A#5', 'B5',
            'C6', 'C#6', 'D6', 'D#6', 'E6', 'F6', 'F#6', 'G6', 'G#6', 'A6', 'A#6', 'B6'
        ];

        // Create a chart container with input and display
        function createChartContainer(index) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.id = `chart-${index}`;

            const fingeringChart = document.createElement('div');
            fingeringChart.className = 'fingering-chart';

            const noteInput = document.createElement('input');
            noteInput.type = 'text';
            noteInput.className = 'note-input';
            noteInput.placeholder = 'Note';
            noteInput.dataset.index = index;
            noteInput.addEventListener('input', handleNoteChange);
            noteInput.addEventListener('blur', handleNoteBlur); // Add blur event listener

            const fingeringDisplay = document.createElement('div');
            fingeringDisplay.className = 'fingering-display';
            fingeringDisplay.id = `fingering-${index}`;
            fingeringDisplay.addEventListener('click', toggleBackground);

            const emptyFingering = document.createElement('div');
            emptyFingering.className = 'empty-fingering';

            fingeringDisplay.appendChild(emptyFingering);
            fingeringChart.appendChild(noteInput);
            fingeringChart.appendChild(fingeringDisplay);
            chartContainer.appendChild(fingeringChart);

            return chartContainer;
        }

        function handleNoteChange(event) {
            const index = event.target.dataset.index;
            let note = event.target.value.toUpperCase();

            // Handle separator
            const chartContainer = event.target.closest('.chart-container');
            if (note === '|') {
                chartContainer.classList.add('separator');
                // Clear the fingering display
                const fingeringDisplay = document.getElementById(`fingering-${index}`);
                fingeringDisplay.innerHTML = '';
                return;
            } else {
                chartContainer.classList.remove('separator');
            }

            // Extract duration if present
            let duration = '';
            if (note.includes(':')) {
                const parts = note.split(':');
                note = parts[0];
                duration = parts[1];
                event.target.value = note; // Update input to show only the note
                event.target.dataset.duration = duration;
            } else if (event.target.dataset.duration) {
                // Preserve existing duration if no new one was provided
                duration = event.target.dataset.duration;
            }

            // Mark as rest if the note is "0"
            if (note === '0') {
                chartContainer.classList.add('rest');

                // Create rest display
                const fingeringDisplay = document.getElementById(`fingering-${index}`);
                fingeringDisplay.innerHTML = '';

                // Add rest symbol instead of duration symbol if appropriate
                if (duration) {
                    const durationElement = document.createElement('div');
                    durationElement.className = 'note-duration';
                    // Use rest symbol if available, otherwise use regular duration symbol
                    durationElement.textContent = durationSymbols[duration + 'r'] || durationSymbols[duration] || '';
                    fingeringDisplay.appendChild(durationElement);
                }

                const emptyFingering = document.createElement('div');
                emptyFingering.className = 'empty-fingering';
                emptyFingering.textContent = 'Rest';
                fingeringDisplay.appendChild(emptyFingering);
                return;
            } else {
                chartContainer.classList.remove('rest');
            }

            // Don't auto-replace note until blur
            // We'll just update the fingering display with the current value
            updateFingeringDisplay(index, note, duration);
        }

        function handleNoteBlur(event) {
            const index = event.target.dataset.index;
            let note = event.target.value.toUpperCase();

            // Skip if separator or empty
            if (note === '|' || note === '') return;

            // Skip if there's already an octave designation
            if (/[A-G](#|b)?[3-6]/.test(note)) return;

            // Resolve aliases on blur
            if (aliases[note]) {
                note = aliases[note];
                event.target.value = note;
            } else if (higherOctaveAliases[note]) {
                note = higherOctaveAliases[note];
                event.target.value = note;
            } else if (lowerOctaveAliases[note]) {
                note = lowerOctaveAliases[note];
                event.target.value = note;
            }

            // Keep any duration information
            const duration = event.target.dataset.duration;
            updateFingeringDisplay(index, note, duration);
        }

        let currentFingeringSystem = 'german';

        function toggleFingeringSystem() {
            const toggleButton = document.getElementById('fingering-toggle');

            if (currentFingeringSystem === 'baroque') {
                currentFingeringSystem = 'german';
                toggleButton.textContent = 'German';
            } else {
                currentFingeringSystem = 'baroque';
                toggleButton.textContent = 'Baroque';
            }

            // Update all displayed fingerings
            const allInputs = document.querySelectorAll('.note-input');
            allInputs.forEach(input => {
                if (input.value) {
                    const index = input.dataset.index;
                    updateFingeringDisplay(index, input.value);
                }
            });
        }

        function updateFingeringDisplay(index, note, duration) {
            const fingeringDisplay = document.getElementById(`fingering-${index}`);
            const chartContainer = fingeringDisplay.closest('.chart-container');

            // If no duration was passed, check if there's one in the input's dataset
            if (!duration) {
                const input = document.querySelector(`.note-input[data-index="${index}"]`);
                if (input && input.dataset.duration) {
                    duration = input.dataset.duration;
                }
            }

            // Preserve background classes
            const hasRedBg = chartContainer.classList.contains('bg-red');
            const hasGreenBg = chartContainer.classList.contains('bg-green');

            // Handle separator
            if (chartContainer.classList.contains('separator')) {
                fingeringDisplay.innerHTML = '';
                return;
            }

            // Check for sharp/flat notes
            if (note && (note.includes('#') || note.includes('B') &&
                !['B3', 'B4', 'B5', 'B6'].includes(note))) {
                chartContainer.classList.add('black-key');
            } else {
                chartContainer.classList.remove('black-key');
            }

            fingeringDisplay.innerHTML = '';

            // Handle rest
            if (note === '0') {
                // For rests, just show the rest symbol centered in the display
                if (duration) {
                    const durationElement = document.createElement('div');
                    durationElement.className = 'note-duration-centered';

                    // Map the duration to the appropriate rest symbol
                    let restSymbol = '';
                    if (duration === '1' || duration === '1.') restSymbol = 'ùÑª'; // Whole rest
                    else if (duration === '2' || duration === '2.') restSymbol = 'ùÑº'; // Half rest
                    else if (duration === '4' || duration === '4.') restSymbol = 'ùÑΩ'; // Quarter rest
                    else if (duration === '8' || duration === '8.') restSymbol = 'ùÑæ'; // Eighth rest
                    else if (duration === '16' || duration === '16.') restSymbol = 'ùÑø'; // Sixteenth rest
                    else restSymbol = durationSymbols[duration] || ''; // Fall back to regular duration symbol

                    durationElement.textContent = restSymbol;
                    fingeringDisplay.appendChild(durationElement);
                }

                const emptyFingering = document.createElement('div');
                emptyFingering.className = 'empty-fingering';
                emptyFingering.textContent = 'Rest';
                fingeringDisplay.appendChild(emptyFingering);
                return;
            }

            if (!note || !fingeringData[note] && allNotesExtended.includes(note)) {
                const emptyFingering = document.createElement('div');
                emptyFingering.className = 'empty-fingering';

                // Keep "Out of range" limited to the original range
                if (allNotesExtended.indexOf(note) < allNotesExtended.indexOf('C4') ||
                    allNotesExtended.indexOf(note) > allNotesExtended.indexOf('F5')) {
                    emptyFingering.textContent = 'Out of range';
                } else {
                    emptyFingering.textContent = 'Unknown fingering';
                }

                fingeringDisplay.appendChild(emptyFingering);
                return;
            } else if (!note || !allNotesExtended.includes(note)) {
                const emptyFingering = document.createElement('div');
                emptyFingering.className = 'empty-fingering';
                fingeringDisplay.appendChild(emptyFingering);
                return;
            }

            // Get fingering based on current system
            let fingering;
            if (currentFingeringSystem === 'german' && fingeringDataGerman[note]) {
                fingering = fingeringDataGerman[note];
            } else {
                fingering = fingeringData[note];
            }

            // Create fingering display with vertical arrangement
            const fingeringHoles = document.createElement('div');
            fingeringHoles.className = 'fingering-holes';

            // Create left hand holes
            const leftHand = document.createElement('div');
            leftHand.className = 'hand';

            fingering.left.forEach((state, i) => {
                const hole = document.createElement('div');
                hole.className = `hole ${state}`;
                if (i === 0) hole.classList.add('left-thumb');
                leftHand.appendChild(hole);
            });

            // Add duration symbol in the middle (between hands)
            if (duration && durationSymbols[duration]) {
                const durationElement = document.createElement('div');
                durationElement.className = 'duration-between-hands';
                durationElement.textContent = durationSymbols[duration];
                fingeringHoles.appendChild(leftHand);
                fingeringHoles.appendChild(durationElement);
            } else {
                fingeringHoles.appendChild(leftHand);
            }

            // Create right hand holes
            const rightHand = document.createElement('div');
            rightHand.className = 'hand';

            fingering.right.forEach(state => {
                const hole = document.createElement('div');
                hole.className = `hole ${state}`;
                rightHand.appendChild(hole);
            });

            // Append right hand
            fingeringHoles.appendChild(rightHand);
            fingeringDisplay.appendChild(fingeringHoles);

            // Restore background class
            if (hasRedBg) {
                chartContainer.classList.add('bg-red');
            } else if (hasGreenBg) {
                chartContainer.classList.add('bg-green');
            }
        }

        // Toggle background color between none, red, and green
        function toggleBackground(event) {
            const chartContainer = event.currentTarget.closest('.chart-container');

            if (chartContainer.classList.contains('bg-red')) {
                chartContainer.classList.remove('bg-red');
                chartContainer.classList.add('bg-green');
            } else if (chartContainer.classList.contains('bg-green')) {
                chartContainer.classList.remove('bg-green');
            } else {
                chartContainer.classList.add('bg-red');
            }
        }

        // Copy notes to clipboard
        function copyNotesToClipboard() {
            const noteInputs = document.querySelectorAll('#note-grid .note-input');
            const chartContainers = document.querySelectorAll('#note-grid .chart-container');
            const notes = [];

            for (let i = 0; i < noteInputs.length; i++) {
                const input = noteInputs[i];
                const container = chartContainers[i];

                if (container.classList.contains('separator')) {
                    notes.push('|');
                } else if (input.value.trim()) {
                    let noteText = input.value.trim();
                    const duration = input.dataset.duration;

                    if (duration) {
                        noteText += ':' + duration;
                    }

                    notes.push(noteText);
                }
            }

            const noteText = notes.join(' ');

            if (noteText) {
                navigator.clipboard.writeText(noteText)
                    .then(() => {
                        showFeedback('Notes copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Failed to copy text: ', err);
                        alert('Could not copy to clipboard. Please check browser permissions.');
                    });
            } else {
                alert('No notes to copy.');
            }
        }

        // Show feedback message
        function showFeedback(message) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.textContent = message;
            feedbackDiv.style.position = 'fixed';
            feedbackDiv.style.top = '20px';
            feedbackDiv.style.left = '50%';
            feedbackDiv.style.transform = 'translateX(-50%)';
            feedbackDiv.style.padding = '10px 20px';
            feedbackDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            feedbackDiv.style.color = 'white';
            feedbackDiv.style.borderRadius = '5px';
            feedbackDiv.style.zIndex = '1000';

            document.body.appendChild(feedbackDiv);

            setTimeout(() => {
                document.body.removeChild(feedbackDiv);
            }, 2000);
        }

        async function pasteNotesFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                let noteStrings = [];

                // Process input text to handle vertical bars
                const segments = text.split('|');
                for (let i = 0; i < segments.length; i++) {
                    const segmentNotes = segments[i].trim().split(/\s+/).filter(note => note.trim());
                    noteStrings = noteStrings.concat(segmentNotes);

                    // Add a separator if not the last segment and if there are more segments
                    if (i < segments.length - 1 && segments.length > 1) {
                        noteStrings.push('|');
                    }
                }

                // Updated regex to account for extended range and duration notation
                const validNoteRegex = /^([A-G](#|b)?(\+|\+\+|-|3|4|5|6)?)(:[0-9]+\.?)?$|^(0)(:[0-9]+\.?)?$|^\|$/i;
                if (!noteStrings.every(note => validNoteRegex.test(note))) {
                    alert('Invalid note format detected. Please ensure all notes are in the correct format: [A-G][#b]?[3456+-]?[:duration]? or 0[:duration]? or |');
                    return;
                }

                // Clear existing notes
                const allInputs = document.querySelectorAll('#note-grid .note-input');
                allInputs.forEach(input => {
                    input.value = '';
                    const chartContainer = input.closest('.chart-container');
                    chartContainer.classList.remove('separator', 'rest');
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                });

                // Fill with new notes
                const startIndex = allNotes.length; // Skip reference row
                let gridIndex = 0;

                for (let i = 0; i < noteStrings.length; i++) {
                    const inputElement = document.querySelector(`input[data-index="${startIndex + gridIndex}"]`);
                    if (!inputElement) break; // Stop if we're out of grid space

                    if (noteStrings[i] === '|') {
                        // For separators, set the input value to "|"
                        inputElement.value = '|';
                        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                    } else {
                        // Process note with possible duration notation
                        inputElement.value = noteStrings[i].toUpperCase();
                        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                    }

                    gridIndex++;
                }
            } catch (err) {
                console.error('Failed to read clipboard: ', err);
                alert('Could not access clipboard. Please check browser permissions.');
            }
        }

        function canTranspose(direction) {
            let highestNote = null;
            let lowestNote = null;
            const noteInputs = document.querySelectorAll('#note-grid .note-input');

            noteInputs.forEach(input => {
                if (input.value.trim()) {
                    let note = input.value.toUpperCase();

                    // Resolve aliases
                    if (aliases[note]) {
                        note = aliases[note];
                    } else if (higherOctaveAliases[note]) {
                        note = higherOctaveAliases[note];
                    } else if (lowerOctaveAliases[note]) {
                        note = lowerOctaveAliases[note];
                    }

                    // Skip if not a valid note
                    if (!allNotesExtended.includes(note)) return;

                    const noteIndex = allNotesExtended.indexOf(note);
                    if (noteIndex === -1) return;

                    // Track highest/lowest notes
                    if (highestNote === null || noteIndex > allNotesExtended.indexOf(highestNote)) {
                        highestNote = note;
                    }

                    if (lowestNote === null || noteIndex < allNotesExtended.indexOf(lowestNote)) {
                        lowestNote = note;
                    }
                }
            });

            // No notes found
            if (highestNote === null || lowestNote === null) {
                return false;
            }

            // Check limits
            if (direction === 'up') {
                return allNotesExtended.indexOf(highestNote) < allNotesExtended.length - 1;
            } else {
                return allNotesExtended.indexOf(lowestNote) > 0;
            }
        }

        function transposeNotes(direction) {
            if (!canTranspose(direction)) {
                return;
            }

            const noteInputs = document.querySelectorAll('#note-grid .note-input');

            noteInputs.forEach(input => {
                if (input.value.trim()) {
                    let note = input.value.toUpperCase();
                    // Store the duration to preserve it
                    const duration = input.dataset.duration;

                    // Resolve aliases
                    let standardizedNote = note;
                    if (aliases[note]) {
                        standardizedNote = aliases[note];
                    } else if (higherOctaveAliases[note]) {
                        standardizedNote = higherOctaveAliases[note];
                    } else if (lowerOctaveAliases[note]) {
                        standardizedNote = lowerOctaveAliases[note];
                    }

                    // Skip if not valid
                    if (!allNotesExtended.includes(standardizedNote)) return;

                    const noteIndex = allNotesExtended.indexOf(standardizedNote);
                    if (noteIndex === -1) return;

                    // Calculate new index and update
                    const newIndex = direction === 'up' ? noteIndex + 1 : noteIndex - 1;
                    if (newIndex >= 0 && newIndex < allNotesExtended.length) {
                        const newNote = allNotesExtended[newIndex];

                        // Update the input with just the note (no duration)
                        input.value = newNote;

                        // Preserve duration in dataset
                        if (duration) {
                            input.dataset.duration = duration;
                        }

                        // Trigger input event to update display
                        input.dispatchEvent(new Event('input', { bubbles: true }));

                        // Fix display since handleNoteChange may have removed duration from input
                        updateFingeringDisplay(input.dataset.index, newNote, duration);
                    }
                }
            });

            updateTransposeButtons();
        }

        // Update transpose button states
        function updateTransposeButtons() {
            document.getElementById('transpose-down').disabled = !canTranspose('down');
            document.getElementById('transpose-up').disabled = !canTranspose('up');
        }

        // Initialize grid
        function initializeGrid() {
            const referenceRow = document.getElementById('reference-row');
            const noteGrid = document.getElementById('note-grid');

            // Create reference row with all notes
            for (let i = 0; i < allNotes.length; i++) {
                const chartContainer = createChartContainer(i);
                referenceRow.appendChild(chartContainer);

                // Pre-fill reference row
                const noteInput = chartContainer.querySelector('.note-input');
                noteInput.value = allNotes[i];
            }

            // Create main grid
            for (let i = allNotes.length; i < 128; i++) {
                const chartContainer = createChartContainer(i);
                noteGrid.appendChild(chartContainer);
            }

            // Update all pre-filled inputs
            for (let i = 0; i < allNotes.length; i++) {
                updateFingeringDisplay(i, allNotes[i]);
            }
            document.getElementById('header-wrapper').classList.add('minimized');
            document.getElementById('minimize-button').innerHTML = '&#43;';
        }

        // Set up keyboard shortcuts and event listeners
        function setupEventListeners() {
            // Minimize button
            document.getElementById('minimize-button').addEventListener('click', function () {
                const headerWrapper = document.getElementById('header-wrapper');
                headerWrapper.classList.toggle('minimized');
                this.innerHTML = headerWrapper.classList.contains('minimized') ? '&#43;' : '&#x2212;';
            });

            // Control bar buttons
            document.getElementById('copy-button').addEventListener('click', copyNotesToClipboard);
            document.getElementById('paste-button').addEventListener('click', pasteNotesFromClipboard);
            document.getElementById('transpose-up').addEventListener('click', () => transposeNotes('up'));
            document.getElementById('transpose-down').addEventListener('click', () => transposeNotes('down'));
            document.getElementById('fingering-toggle').addEventListener('click', toggleFingeringSystem);

            // Keyboard shortcuts
            document.addEventListener('keydown', function (event) {
                // Ctrl+P for paste (prevent print dialog)
                if (event.ctrlKey && event.key === 'p') {
                    event.preventDefault();
                    pasteNotesFromClipboard();
                }

                // Ctrl+V for paste (when not in input field)
                if (event.ctrlKey && event.key === 'v' && document.activeElement.tagName !== 'INPUT') {
                    event.preventDefault();
                    pasteNotesFromClipboard();
                }

                // Ctrl+C for copy (when no text selected and not in input)
                if (event.ctrlKey && event.key === 'c' &&
                    !window.getSelection().toString() &&
                    document.activeElement.tagName !== 'INPUT') {
                    event.preventDefault();
                    copyNotesToClipboard();
                }
            });

            // Update transpose buttons when inputs change
            const allInputs = document.querySelectorAll('.note-input');
            allInputs.forEach(input => {
                input.addEventListener('input', () => setTimeout(updateTransposeButtons, 0));
            });
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            initializeGrid();
            setupEventListeners();
            updateTransposeButtons();
        });
    </script>
</body>

</html>